$.fn.upload=function(n){function w(n){if(n==null||n==undefined||$.trim(n).length==0)return"";var r=n.split("|"),t=[],i=0;return $.each([{key:"3gpp",val:"audio/3gpp,video/3gpp"},{key:"ac3",val:"audio/ac3"},{key:"asf",val:"allpication/vnd.ms-asf"},{key:"au",val:"audio/basic"},{key:"css",val:"text/css"},{key:"csv",val:"text/csv"},{key:"doc",val:"application/msword"},{key:"dot",val:"application/msword"},{key:"dtd",val:"application/xml-dtd"},{key:"dwg",val:"image/vnd.dwg"},{key:"dxf",val:"image/vnd.dxf"},{key:"gif",val:"image/gif"},{key:"htm",val:"text/html"},{key:"html",val:"text/html"},{key:"jp2",val:"image/jp2"},{key:"jpe",val:"image/jpeg"},{key:"jpeg",val:"image/jpeg"},{key:"jpg",val:"image/jpeg"},{key:"js",val:"text/javascript,application/javascript"},{key:"json",val:"application/json"},{key:"mp2",val:"audio/mpeg,video/mpeg"},{key:"mp3",val:"audio/mpeg"},{key:"mp4",val:"audio/mp4,video/mp4"},{key:"mpeg",val:"video/mpeg"},{key:"mpg",val:"video/mpeg"},{key:"mpp",val:"application/vnd.ms-project"},{key:"ogg",val:"application/ogg,audio/ogg"},{key:"pdf",val:"application/pdf"},{key:"png",val:"image/png"},{key:"pot",val:"application/vnd.ms-powerpoint"},{key:"pps",val:"application/vnd.ms-powerpoint"},{key:"ppt",val:"application/vnd.ms-powerpoint"},{key:"rtf",val:"application/rtf,text/rtf"},{key:"svf",val:"image/vnd.svf"},{key:"tif",val:"image/tiff"},{key:"tiff",val:"image/tiff"},{key:"txt",val:"text/plain"},{key:"wdb",val:"application/vnd.ms-works"},{key:"wps",val:"application/vnd.ms-works"},{key:"xhtml",val:"application/xhtml+xml"},{key:"xlc",val:"application/vnd.ms-excel"},{key:"xlm",val:"application/vnd.ms-excel"},{key:"xls",val:"application/vnd.ms-excel"},{key:"xlt",val:"application/vnd.ms-excel"},{key:"xlw",val:"application/vnd.ms-excel"},{key:"xml",val:"text/xml,application/xml"},{key:"zip",val:"aplication/zip"},{key:"xlsx",val:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}],function(n,u){$.each(r,function(n,r){u.key==r&&(t[i]=u.val,i++)})}),t.join(",")}function s(n){var t=new RegExp(".*.(jpg|jpeg|png|gif|bmp)$");return t.test(n.toLowerCase())?!0:!1}function p(n){var t;switch(n){case".txt":t="fa-file-text-o text-muted";break;case".docx":case".doc":t="fa-file-word-o text-primary";break;case".xlsx":case".xls":t="fa-file-excel-o text-success";break;case".pptx":case".ppt":t="fa-file-powerpoint-o text-danger";break;case".pdf":t="fa-file-pdf-o text-danger";break;default:t="fa-file-o text-muted"}return t}function b(n){return n==null||n==undefined||$.trim(n).length==0?!0:!1}function k(n){var i="",f="",u="",e=n.names.split("|");s(n.suffix)?(f=string.format('<img style="width: 50px;height: 50px;" class="img-rounded" src="{0}" alt="图片不存在">',n.path+"/"+e[0]),u='<a href="javascript:void(0);" title="预览" data-type="search" class="btn btn-default fileControl-color"><i class="fa fa-search-plus" aria-hidden="true"><\/i><\/a>'):f=string.format('<i class="fa {0}" style="font-size:50px;" aria-hidden="true"><\/i>',p(n.suffix));u=u+'<a href="javascript:void(0);" title="下载" data-type="download" class="btn btn-default fileControl-color"><i class="fa fa-download" aria-hidden="true"><\/i><\/a><a href="javascript:void(0);" title="删除" data-type="remove" class="btn btn-default fileControl-color"><i class="fa fa-trash" aria-hidden="true"><\/i><\/a>';i=$(string.format('<tr id="{0}">                                    <td style="width:60px;">{1}<\/td>                                    <td style="text-align:left;">{2}<\/td>                                    <td style="width:160px;">{3}<\/td>                                    <td style="width:160px;">{4}<\/td>                                    <td style="width:140px;text-align:left;">{5}<\/td>                                <\/tr>',n.id,f,n.name,time.format(n.createTime,t.formatter),n.createByName,u));i.find('a[data-type="search"]').on("click",function(){h(n)});i.find('a[data-type="download"]').attr("href",t.downloadUrl+"?fileURL="+n.url);i.find('a[data-type="remove"]').on("click",function(){a(n)});r.find(".fileControl-content").append(i)}function d(n){var i="",u="";s(n.suffix)&&(u='<a href="javascript:void(0);" title="预览" data-type="search">预览<\/a>');u+='<a href="javascript:void(0);" title="下载" data-type="download">下载<\/a><a href="javascript:void(0);" title="删除" data-type="remove">删除<\/a>';i=$(string.format('<tr id="{0}">                                    <td style="text-align:left;">{1}<\/td>                                    <td style="width:160px;">{2}<\/td>                                    <td style="width:160px;">{3}<\/td>                                    <td style="width:134px;text-align:left;">{4}<\/td>                                <\/tr>',n.id,n.name,time.format(n.createTime,t.formatter),n.createByName,u));i.find('a[data-type="search"]').on("click",function(){h(n)});i.find('a[data-type="download"]').attr("href",t.downloadUrl+"?fileURL="+n.url);i.find('a[data-type="remove"]').on("click",function(){a(n)});r.find(".fileControl-content").append(i)}function g(n){var i="",u="",f="",e=n.names.split("|");s(n.suffix)?(f=string.format('<img class="img-rounded" style="width:155px;height:155px;" src="{0}" alt="图片不存在">',n.path+"/"+e[1]),u='<a href="javascript:void(0);" title="预览" data-type="search" class="btn btn-default fileControl-color"><i class="fa fa-search-plus" aria-hidden="true"><\/i><\/a>'):f=string.format('<i class="fa {0}" style="font-size:155px;" aria-hidden="true"><\/i>',p(n.suffix));u+='<a href="javascript:void(0);" title="下载" data-type="download" class="btn btn-default fileControl-color"><i class="fa fa-download" aria-hidden="true"><\/i><\/a><a href="javascript:void(0);" title="删除" data-type="remove" class="btn btn-default fileControl-color"><i class="fa fa-trash" aria-hidden="true"><\/i><\/a>';i=$(string.format('<div class="col-md-2" id="{0}">                                        <div class="thumbnail text-center">                                            {1}                                            <div class="caption" style="padding-left:0px; padding-right:0px;">                                                <p class="fileControl-size fileControl-color" title="{2}">{3}<\/p>                                                <p class="fileControl-btn">{4}<\/p>                                            <\/div>                                        <\/div>                                    <\/div>',n.id,f,n.name,string.subString(n.name,13),u));i.find('a[data-type="search"]').on("click",function(){h(n)});i.find('a[data-type="download"]').attr("href",t.downloadUrl+"?fileURL="+n.url);i.find('a[data-type="remove"]').on("click",function(){a(n)});r.find(".fileControl-content").append(i)}function h(n){var i=$("#"+t.targetId);i.find("#"+t.targetId+"Lab").text(n.name);i.find("img").attr("src",n.url);$("#"+t.targetId).modal("show")}function c(n){t.date.push({id:n.id,name:n.name,url:n.url,type:n.type,suffix:n.suffix,path:n.path,names:n.names,createTime:time.format(n.createTime,"yyyy-MM-dd hh:mm:ss")})}function nt(n){$.each(t.date,function(i,r){if(r.id==n.id)return t.date=array.remove(t.date,r),!1})}function tt(){t.date=array.removeAll(t.date)}function a(n){$.isFunction(n)?l=n:(nt(n),r.find(".fileControl-content").find("#"+n.id).remove(),$.isFunction(l)&&l(n))}var i=$(this),t,y,u,f,r,o,e,it,l,rt,v;i.hide();t={buttonTxt:"上传",buttonStyle:"",uploadUrl:"",downloadUrl:"",saveUrl:"../../FileService/SaveData",queryUrl:"../../FileService/QueryData",isLocal:"true",mode:"ico",target:null,multiple:"false",onlyFile:"false",fileTypes:null,minFileSize:0,maxFileSize:2147483648,thumbnailSizes:"50;155",createByName:null,formatter:"yyyy-MM-dd hh:mm:ss",date:[]};y={buttonTxt:i.attr("data-buttontxt"),buttonStyle:i.attr("data-button-style"),uploadUrl:i.attr("data-uploadurl"),saveUrl:i.attr("data-saveurl"),queryUrl:i.attr("data-queryurl"),isLocal:i.attr("data-islocal"),downloadUrl:i.attr("data-downloadrrl"),mode:i.attr("data-mode"),target:i.attr("data-target"),multiple:i.attr("data-multiple"),onlyFile:i.attr("data-onlyfile"),fileTypes:i.attr("data-filetypes"),minFileSize:i.attr("data-minfilesize"),maxFileSize:i.attr("data-maxfilesize"),thumbnailSizes:i.attr("data-thumbnailsizes"),formatter:i.attr("data-format")};$.extend(t,n,y);u=0;f=0;t.isLocal=="false"?(t.uploadUrl="../../FileService/FileServiceUpload",t.downloadUrl="../../FileService/FileServiceDownload"):(t.uploadUrl="../../FileService/Upload",t.downloadUrl="../../FileService/Download");t.targetId=guid.new();t.fileCode=guid.new();i.attr("data-code",t.fileCode);r=$(t.target);o=$('<div style="float:left;width:100%;"><button type="button" class="btn btn-default fileControl-marBot10" style="'+t.buttonStyle+'"><span class="glyphicon glyphicon-cloud-upload" aria-hidden="true"><\/span> '+t.buttonTxt+"<\/button><\/ div>");t.buttonUpload=o.find("button").on("click",function(){$("[data-code="+t.fileCode+"]").click()});i.after(o);t.modal=$(string.format('<div class="modal fade" tabindex="-1" role="dialog" aria-labelledby="{0}ModalLab" id="{0}">            <div class="modal-dialog" role="document">                <div class="modal-content">                    <div class="modal-header">                        <button type="button" class="close" style="margin-top:0px;" title="关闭"><span aria-hidden="true">&times;<\/span><\/button>                        <h4 class="modal-title" id="{0}Lab"><\/h4>                    <\/div>                    <div class="modal-body thumbnail" style="border-width:0px;">                        <img src="" alt="找不到图片" class="img-rounded">                    <\/div>                <\/div>            <\/div>        <\/div>',t.targetId));t.modal.find(".close").on("click",function(){t.modal.modal("hide")});$("body:first").append(t.modal);e='<div class="fileControl-queueID"><\/div>';switch(t.mode){case"ico":case"list":e+='<table class="table table-bordered table-hover fileControl-table"><tbody class="fileControl-content"><\/tbody><\/table>';break;case"view":e+='<div class="row fileControl-content"><\/div>'}return r.append($(e)),$.trim(t.fileTypes).length>0&&t.fileTypes!=null&&i.attr("accept",w(t.fileTypes)),t.multiple=="true"&&i.attr("multiple",""),t._saveCallback=function(){},t._bindCallback=function(){},i.fileupload({type:"POST",url:t.uploadUrl,dataType:"json",paramName:"BitFile",autoUpload:!0,formData:function(n){var i=n.serializeArray();return i.push({name:"thumbnailSizes",value:t.thumbnailSizes}),i.push({name:"token",value:"admin"}),i.push({name:"password",value:"admin"}),i},add:function(n,i){var e,o,f;if(u==0&&(u++,r.find(".fileControl-queueID").show()),(t.minFileSize!=null||t.minFileSize!=undefined)&&i.files[0].size<t.minFileSize){alert("【"+i.files[0].name+"】文件的size必须大于或等于"+t.minFileSize);return}if((t.maxFileSize!=null||t.maxFileSize!=undefined)&&i.files[0].size>t.maxFileSize){alert("【"+i.files[0].name+"】文件的size必须小于或等于"+t.maxFileSize);return}if(t.fileTypes!=null&&t.fileTypes!=undefined&&t.fileTypes.length>0&&(e=".*.("+t.fileTypes+")$",o=new RegExp(e),!o.test(i.files[0].name.toLowerCase()))){alert("【"+i.files[0].name+"】文件的类型不正确，必须是【"+t.fileTypes+"】");return}t.multiple=="false"&&t.onlyFile=="true"&&t.clear();f=$(string.format('<div class="row" style="margin:10px 0px;" name="{0}">                                                <div name="{0}" class="progress col-md-11 fileControl-margin0 fileControl-padding0">                                                    <div class="progress-bar progress-bar-striped active" role="progressbar" aria-valuemin="0" aria-valuemax="100" name="ProgressBar" title="{1}{2}" style="min-width:20%; width:0%;">{1}{2}<\/div>                                                <\/div>                                                <div class="col-md-1 text-right fileControl-margin0 fileControl-padding0">                                                    <a href="javascript:void(0);" title="取消" data-type="cancel" style="margin-left:5px;" class="text-danger"><span class="glyphicon glyphicon-remove" aria-hidden="true"><\/span><\/a>                                                <\/div>                                            <\/div>',i.files[0].lastModifiedDate.toJSON(),i.files[0].name,"（上传：0%）"));f.find('a[data-type="cancel"]').on("click",function(){i.abort()});r.find(".fileControl-queueID").append(f);i.submit()},done:function(n,i){r.find('div[name="'+i.files[0].lastModifiedDate.toJSON()+'"]').remove();t.bind(i.result.data,!1);$.isFunction(v)&&v(i.result.data)},fail:function(n,t){t.errorThrown=="abort"?r.find('div[name="'+t.files[0].lastModifiedDate.toJSON()+'"]').remove():alert("【"+t.files[0].name+"】文件上传失败，请联系管理员")},progress:function(n,t){var i=parseInt(t.loaded/t.total*100,10),u=r.find('div[name="'+t.files[0].lastModifiedDate.toJSON()+'"]');if(i>=100){u.find('div[name="ProgressBar"]').removeClass("active").addClass("progress-bar-success").css("width","100%").attr("title",t.files[0].name+"（上传：100%；处理中）").text(t.files[0].name+"（上传：100%；处理中）");u.find('a[data-type="cancel"]').remove();return}u.find('div[name="ProgressBar"]').css("width",i+"%").attr("title",t.files[0].name+"（上传："+i+"%）").text(t.files[0].name+"（上传："+i+"%）")},always:function(n,t){f++;t.originalFiles.length==f&&(r.find(".fileControl-queueID").hide(),u=0,f=0)}}),t.bind=function(n,i){if($.isFunction(n))it=n;else{(n.names==null||n.names==undefined)&&(n.names="");b(n.createByName)&&(n.createByName=t.createByName);switch(t.mode){case"ico":k(n);c(n);break;case"list":d(n);c(n);break;case"view":g(n);c(n)}i!=!1&&t._bindCallback(n)}},t.clear=function(){tt();r.find(".fileControl-content").html("")},t.save=function(n){$.isFunction(n)?rt=n:$.ajax({url:t.saveUrl,cache:!1,type:"POST",data:{RelationID:n,files:t.date},success:function(n){if(n.code==1){alert(n.msg);return}t._saveCallback(n.data)},error:function(n){alert("保存文件错误，请联系管理员");console.log(n.responseText)}})},t.query=function(n){$.ajax({url:t.queryUrl,cache:!1,type:"POST",data:{RelationID:n},success:function(n){if(n.code==1){alert(n.msg);return}t.clear();$.each(n.data,function(n,i){t.bind(i)})},error:function(n){alert("保存文件错误，请联系管理员");console.log(n.responseText)}})},t.buttonVisible=function(n){$.each(n,function(n,t){t.val==!0?r.find('a[data-type="'+t.key+'"]').hide():r.find('a[data-type="'+t.key+'"]').show()})},t.buttonDisabled=function(n){$.each(n,function(n,t){t.val==!0?r.find('a[data-type="'+t.key+'"]').attr("disabled","disabled"):r.find('a[data-type="'+t.key+'"]').removeAttr("disabled")})},t.uploadVisible=function(n){n==!0?t.buttonUpload.hide():t.buttonUpload.show()},t.uploadEnabled=function(n){n==!0?t.buttonUpload.attr("readonly","readonly"):t.buttonUpload.removeAttr("readonly")},t.upload=function(n){$.isFunction(n)&&(v=n)},t};